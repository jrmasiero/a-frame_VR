<!doctype HTML>

<!DBLAB VIRTUAL - DIGITAL TWIN DO NOSSO LABORATIORIO COM DADOS DOS SENSORES>

<html>
<meta name="apple-mobile-web-app-capable" content="yes">
<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
<!--script src="https://rawgit.com/aframevr/aframe/4f0540b/dist/aframe-master.min.js"></script-->
<script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v4.1.2/dist/aframe-extras.min.js"></script>
<script src="https://unpkg.com/aframe-animation-component@^5.1.2/dist/aframe-animation-component.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>


</head>
  <body>
    <! Habilita o controle com o mouse>
    <a-scene cursor="rayOrigin: mouse">

      <a-assets>

  <a-asset-item id="dblab" src="../3d/4_0.gltf"></a-asset-item>

  <a-asset-item id="storm" src="../3d/scene.gltf"></a-asset-item>

<video id="intro" src="../3d/DBLab.webm" playsinline></video>

<img id="texture" src="../3d/textures/circ.jpg"></img>

<a-mixin id="checkpoint"></a-mixin>
<a-mixin id="checkpoint-hovered" color="#6CEEB5"></a-mixin>

</a-assets>


<!Camera normal>
<a-entity id="rig"  camera look-controls wasd-controls-enabled="false"  position="0 1.2 -0.5" movement-controls="controls: checkpoint" checkpoint-controls="mode: animate">

</a-entity>


    <a-entity id="bg" geometry="primitive: plane" material="color: blue"position="0 0 5"
     sound="src: url(../3d/bg_1.mp3); autoplay: false"></a-entity>

  <a-video src="#intro" autoplay="false" loop="true"  width="3" height="1.75" scale="0.3 0.3 0.3" position="0.0 1.2764 2.0"></a-video>



      <a-entity id="room" gltf-model="#dblab"  position="0 0 0" animation-mixer="loop:repeat"></a-entity>

      <!Teto para baixo>
      <a-light type="directional" position="-2 2 0" rotation="0 0 0" intensity="2.0" target="#directional_0" >
      <a-entity id="directional_0" position="2 -1 0"></a-entity>
      </a-light>
      <!Teto para baixo>
      <a-light type="directional" position="2 2 0" rotation="0 0 0" intensity="2.0"target="#directional_1">
        <a-entity id="directional_1" position="-2 -1 0"></a-entity>
      </a-light>
      <!Centro para Parede TV>
      <a-light type="directional" position="0.0 1.0 0.0" rotation="0 0 0" intensity="2.5" target="#directional_2">
        <a-entity id="directional_2" position="0 0 1"></a-entity>
      </a-light>
      <!Centro para Parede Armarinho>
      <a-light type="directional" position="0.0 1.0 0.0" rotation="0 0 0" intensity="2.5" target="#directional_3">
        <a-entity id="directional_3" position="0 0 -1"></a-entity>
      </a-light>
      <!Centro para Teto>
      <a-light type="directional" position="0.0 1.0 0.0" rotation="0 0 0" intensity="2.0" target="#directional_4">
        <a-entity id="directional_4" position="0 2 0"></a-entity>
      </a-light>

      <a-text value="Bem vindo ao DBLab!" color="#FF4136"
        position="-1.0 1.4 -1.85" scale="1.0 1.0 1.0"></a-text>



        <a-entity id="trooper" gltf-model="#storm" rotation="0.0 90.0 0.0" position="-4.0 0.0 0.0" scale="0.5 0.5 0.5" animation-mixer="loop:repeat"></a-entity>



              <!controle video>
        <a-entity id="controle_video" geometry="primitive: box" material="color: red; opacity: 0.5" position="-0.6 1.65 1.7" scale="0.2 0.2 0.2"  ></a-entity>

        <!controle temperatura>
  <a-entity id="bot_temp" geometry="primitive: box" material="src: #texture;color: blue; opacity: 0.8" position="0 0.9 0.2" scale="0.2 0.2 0.2">
    <a-animation attribute="material.color" begin="fadein" from="blue" to="green" dur="1000"></a-animation>
    <a-animation attribute="position" begin="fadein" from="0 0.9 0.2" to="0 1.1 0.2" dur="1000"></a-animation>
    <a-animation attribute="rotation" begin="fadein" from="0 0 0" to="0 180 0" dur="1000"></a-animation>
    <a-animation attribute="material.color" begin="fadeout" from="green" to="blue" dur="1000"></a-animation>
    <a-animation attribute="position" begin="fadeout"  from="0 1.1 0.2" to="0 0.9 0.2" dur="1000"></a-animation>
    <a-animation attribute="rotation" begin="fadeout"  from="0 180 0" to="0 0 0" dur="1000"></a-animation>
  </a-entity>
  <a-text id="temperatura" value="Temperatura" color="white"
    position="0.1 0.9 0.15" scale="0.3 0.3 0.3" rotation="0 180 0" visible="false">

  </a-text>

    <!controle umidade>
    <a-entity id="bot_umidade" geometry="primitive: box" material="src: #texture;color: blue; opacity: 0.8" position="-2.5 1.1 0.85" scale="0.4 0.4 0.4">
    <a-animation attribute="material.color" begin="fadein" from="blue" to="red" dur="1000"></a-animation>
    <a-animation attribute="position" begin="fadein" from="-2.5 1.1 0.85" to="-2.5 1.3 0.85" dur="1000"></a-animation>
    <a-animation attribute="rotation" begin="fadein" from="0 0 0" to="0 180 0" dur="1000"></a-animation>
    <a-animation attribute="material.color" begin="fadeout" from="red" to="blue" dur="1000"></a-animation>
    <a-animation attribute="position" begin="fadeout"  from="-2.5 1.3 0.85" to="-2.5 1.1 0.85" dur="1000"></a-animation>
    <a-animation attribute="rotation" begin="fadeout" from="0 180 0" to="0 0 0" dur="1000"></a-animation>
    </a-entity>
    <a-text id="umidade" value="Umidade" color="white"
      position="-2.5 0.9 0.7" scale="0.8 0.8 0.8" rotation="0 90 0" visible="false"></a-text>

      <!controle distancia>
      <a-entity id="bot_dist"  geometry="primitive: box" material="src: #texture;color: blue; opacity: 0.8"  position="2.1 1.0 0.0" scale="0.4 0.4 0.4">
        <a-animation attribute="material.color" begin="fadein" from="blue" to="green" dur="1000"></a-animation>
        <a-animation attribute="position" begin="fadein" from="2.1 1.0 0.0" to="2.1 1.2 0.0" dur="1000"></a-animation>
        <a-animation attribute="rotation" begin="fadein" from="0 0 0" to="0 180 0" dur="1000"></a-animation>
        <a-animation attribute="material.color" begin="fadeout" from="green" to="blue" dur="1000"></a-animation>
        <a-animation attribute="position" begin="fadeout"  from="2.1 1.2 0.0" to="2.1 1.0 0.0" dur="1000"></a-animation>
        <a-animation attribute="rotation" begin="fadeout"  from="0 180 0" to="0 0 0" dur="1000"></a-animation>
      </a-entity>
      <a-text id="distancia" value="Distancia" color="white" position="2.0 0.9 -0.3"  rotation="0 -90 0" scale="0.5 0.5 0.5" visible="false" >

      </a-text>

      <!-- Checkpoints -->
            <a-entity position="0 0 0">
              <a-cylinder checkpoint radius="0.3" height="0.1" position="0 1.2 -0.5" color="#39BB82"></a-cylinder>
              <a-cylinder checkpoint radius="0.3" height="0.1" position="1.5 1.2 1.0" color="#39BB82"></a-cylinder>
              <a-cylinder checkpoint radius="0.3" height="0.1" position="-1.5 1.2 1.0" color="#39BB82"></a-cylinder>
      </a-entity>



  </a-scene>




    <script >
      var targetElx = document.querySelector('#room');
      targetElx.object3D.scale.set(1, 1, 1);
    </script>



    <script>




    var sceneEl = document.querySelector('a-scene');

    //var cam = sceneEl.querySelector('#camx');
    //cam.setAttribute('rotation', {x: 15, y: 30, z: 90});

    var controle_vid = sceneEl.querySelector('#controle_video');
    var video_lab = sceneEl.querySelector('#intro');

    controle_vid.addEventListener('click', function () {



    //video_lab.setAttribute('autoplay', 'true');
    if(video_lab.paused !== true){
    video_lab.pause();
    controle_vid.setAttribute('material', 'color: red');
  } else {
    video_lab.play();
    controle_vid.setAttribute('material', 'color: green');
  }
    });

</script>





<script>



    var info_temperatura = sceneEl.querySelector('#temperatura');
    var info_umidade = sceneEl.querySelector('#umidade');
    var info_distancia = sceneEl.querySelector('#distancia');
    // Create a client instance
    //client = new Paho.MQTT.Client("177.99.211.82", 30076, "clientId");
    client = new Paho.MQTT.Client("iot.eclipse.org", 443, new Date().toString());

    // set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    var options = {
      useSSL: true,
      timeout: 3,
      onSuccess: onConnect
    }


    // connect the client
    client.connect(options);

    // called when the client connects
    function onConnect() {
      client.subscribe("dblab/hands-on/mqtt/display");
      console.log("data   ", new Date());
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
function onMessageArrived(message) {
  message = message.payloadString.toString();
  //console.log("MENSAGEM       ", message);
  if(message[0] == "H"){
    message = message.split('H: ').join('');
    message = message.split('%').join('');
    info_umidade.setAttribute('value', "" + message + "%");
  }else if(message[0] == "T"){
    message = message.split('T: ').join('');
    message = message.split('C').join('');
    info_temperatura.setAttribute('value', "" + message +"C");
  }else if((message[0] + message[1] + message[2] + message[3]) == "Dist"){
    message = message.split('Dist: ').join('');
    message = message.split('mm').join('');
    info_distancia.setAttribute('value', "" + message + "mm");
  }
}

  var cam = sceneEl.querySelector('#camera');

  var b_temp = sceneEl.querySelector('#bot_temp');
  b_temp.addEventListener('click', function () {
    if(info_temperatura.getAttribute("visible")==false){
    b_temp.emit('fadein');
    info_temperatura.setAttribute('visible', "true");

    console.log(info_temperatura.getAttribute("visible"));
  } else {
    b_temp.emit('fadeout');
    info_temperatura.setAttribute('visible', "false");

    console.log(info_temperatura.getAttribute("visible"));
  }

  });


  var b_umi = sceneEl.querySelector('#bot_umidade');
  b_umi.addEventListener('click', function () {
    if(info_umidade.getAttribute("visible")==false){
    b_umi.emit('fadein');
    info_umidade.setAttribute('visible', "true");
    console.log(info_umidade.getAttribute("visible"));
  } else {
    b_umi.emit('fadeout');
    info_umidade.setAttribute('visible', "false");
    console.log(info_umidade.getAttribute("visible"));
  }
  });

  var b_dist = sceneEl.querySelector('#bot_dist');
  b_dist.addEventListener('click', function () {
    if(info_distancia.getAttribute("visible")==false){
    b_dist.emit('fadein');
    info_distancia.setAttribute('visible', "true");
    console.log(info_distancia.getAttribute("visible"));
  } else {
    b_dist.emit('fadeout');
    info_distancia.setAttribute('visible', "false");
    console.log(info_distancia.getAttribute("visible"));
  }
  });

    </script>

  </body>
</html>
